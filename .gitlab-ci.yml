# GitLab CI/CD Pipeline for Flakiness Analysis
# This runs inside gitlab.cee.redhat.com and analyzes the GitLab repos
# Results are pushed to GitHub repo and Grafana Cloud

stages:
  - analyze

analyze-gitlab-flakiness:
  stage: analyze
  image: python:3.11-slim
  tags:
    - shared
    - x86_64

  # Run hourly
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"  # Allow manual runs
    - if: $CI_PIPELINE_SOURCE == "push"  # Also run on push for testing

  variables:
    GIT_STRATEGY: clone

  before_script:
    - apt-get update && apt-get install -y git
    - pip install --no-cache-dir prometheus-client requests
    - git config --global user.name "gitlab-ci[bot]"
    - git config --global user.email "gitlab-ci[bot]@gitlab.cee.redhat.com"

  script:
    # Run the GitLab flakiness analyzer
    - echo "🔍 Analyzing GitLab repos for retests..."
    - python3 analyze_gitlab_flakiness.py

    # Copy the generated JSON file and push to GitHub
    - echo "📤 Pushing results to GitHub repo..."
    - |
      # Clone repo without token
      git clone https://github.com/lenasolarova/konflux_metrics.git /tmp/konflux_metrics
      cd /tmp/konflux_metrics

      # Copy the generated JSON file
      cp ${CI_PROJECT_DIR}/gitlab_flakiness_7days.json .

      # Commit and push to GitHub
      git add gitlab_flakiness_7days.json

      if git diff --cached --quiet; then
        echo "📊 No changes to commit"
      else
        echo "📊 Committing new GitLab retest metrics..."
        git commit -m "chore: update GitLab retest metrics [gitlab-ci]"

        # Create a temporary netrc file for authentication
        cat > ~/.netrc <<EOF
machine github.com
login ${GITHUB_TOKEN}
password x-oauth-basic
EOF
        chmod 600 ~/.netrc

        # Push to GitHub
        git push origin main
        echo "✅ Results pushed to GitHub!"
      fi

  artifacts:
    paths:
      - gitlab_flakiness_7days.json
    expire_in: 90 days
